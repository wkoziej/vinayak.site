{# ABOUTME: Nunjucks template partial for displaying 14-day Panchakarma tour availability calendar #}
{# ABOUTME: Integrates Google Calendar API with responsive Bootstrap layout and accessibility features #}

{# Calendar configuration - these values should be provided by the site configuration #}
{% set calendarConfig = {
  calendarId: calendar.calendarId or 'YOUR_CALENDAR_ID@group.calendar.google.com',
  apiKey: calendar.apiKey or 'YOUR_GOOGLE_API_KEY',
  containerId: calendar.containerId or 'availability-calendar',
  monthsToShow: calendar.monthsToShow or 6
} %}

{# Calendar section with Bootstrap styling #}
<section id="tour-availability" class="py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        
        {# Calendar container - will be populated by JavaScript #}
        <div id="availability-calendar" class="text-center">
          {# Loading placeholder #}
          <div class="calendar-loading">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Loading availability...</span>
            </div>
            <p class="mt-3 text-muted">Loading tour availability...</p>
          </div>
        </div>
        
        {# Contact call-to-action #}
        <div class="text-center mt-4">
          <p class="lead mb-3">
            Ready to begin your healing journey in the Himalayas?
          </p>
          <div class="d-flex justify-content-center">
            <a href="/contact/" class="btn btn-success btn-lg px-5 py-3">
              <i class="bi bi-calendar-check me-2"></i>
              Contact Us to Book Your Journey
            </a>
          </div>
        </div>
        
        {# Additional information #}
        <div class="row mt-5">
          <div class="col-md-6">
            <div class="card h-100 border-success">
              <div class="card-body">
                <h5 class="card-title text-success">
                  <i class="bi bi-info-circle me-2"></i>
                  Booking Information
                </h5>
                <ul class="list-unstyled">
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Tours depart every month based on availability
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Group size limited to 6-8 participants
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Book 2-3 months in advance recommended
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    Customized dates available for private groups
                  </li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 border-primary">
              <div class="card-body">
                <h5 class="card-title text-primary">
                  <i class="bi bi-calendar-event me-2"></i>
                  What's Included
                </h5>
                <ul class="list-unstyled">
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-primary me-2"></i>
                    Complete 14-day Panchakarma treatment
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-primary me-2"></i>
                    Himalayan mountain accommodation
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-primary me-2"></i>
                    Daily Yoga and meditation sessions
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-primary me-2"></i>
                    Cultural heritage site visits
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
</section>

{# Include calendar CSS and JavaScript #}
<link rel="stylesheet" href="/assets/css/calendar.css">

{# Calendar configuration and initialization #}
<script>
  // Calendar configuration
  window.CALENDAR_CONFIG = {
    calendarId: '{{ calendarConfig.calendarId | safe }}',
    apiKey: '{{ calendarConfig.apiKey | safe }}',
    containerId: '{{ calendarConfig.containerId }}',
    monthsToShow: {{ calendarConfig.monthsToShow }}
  };
  
  // Additional error handling and debugging
  console.log('Calendar configuration loaded:', {
    calendarId: window.CALENDAR_CONFIG.calendarId.substring(0, 10) + '...',
    apiKey: window.CALENDAR_CONFIG.apiKey.substring(0, 10) + '...',
    containerId: window.CALENDAR_CONFIG.containerId
  });
  
  // Fallback initialization if auto-init fails
  document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit to ensure calendar.js is loaded
    setTimeout(function() {
      if (window.AyurvedicCalendar && !window.ayurvedicCalendar) {
        console.log('Initializing calendar fallback...');
        try {
          window.ayurvedicCalendar = new window.AyurvedicCalendar(window.CALENDAR_CONFIG);
          window.ayurvedicCalendar.init();
        } catch (error) {
          console.error('Calendar fallback initialization failed:', error);
        }
      }
    }, 1000);
  });
  
  // Manual refresh function for debugging
  window.refreshCalendar = function() {
    if (window.ayurvedicCalendar) {
      window.ayurvedicCalendar.refresh();
    } else {
      console.log('Calendar not initialized. Attempting initialization...');
      if (window.AyurvedicCalendar) {
        window.ayurvedicCalendar = new window.AyurvedicCalendar(window.CALENDAR_CONFIG);
        window.ayurvedicCalendar.init();
      }
    }
  };
</script>

<script src="/assets/js/calendar.js"></script>

{# Schema markup for SEO - TODO: Fix date formatting #}

{# Accessibility improvements #}
<div class="visually-hidden" id="calendar-instructions">
  <p>
    This calendar shows availability for 14-day Himalayan Panchakarma tours. 
    Green dates are available for departure, red dates are unavailable. 
    Use the contact information provided to book your preferred dates.
  </p>
</div>